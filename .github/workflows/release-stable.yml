name: "Release Stable"

on:
  workflow_dispatch:
    inputs:
      beta_tag:
        description: "Beta tag to promote (e.g., v1.4.15-beta.3)"
        required: true
        type: string
      sync_main:
        description: "Sync main branch with develop"
        required: false
        type: boolean
        default: true

concurrency:
  group: release-stable
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  # =============================================================================
  # Validate beta release and prepare stable version
  # =============================================================================
  validate:
    name: "Validate"
    runs-on: ubuntu-latest
    outputs:
      beta_version: ${{ steps.parse.outputs.beta_version }}
      stable_version: ${{ steps.parse.outputs.stable_version }}
    steps:
      - name: "Parse versions"
        id: parse
        run: |
          BETA_TAG="${{ inputs.beta_tag }}"

          # Remove 'v' prefix if present
          BETA_VERSION="${BETA_TAG#v}"

          # Validate format: X.Y.Z-beta.N
          if ! [[ "$BETA_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta\.([0-9]+)$ ]]; then
            echo "::error::Invalid beta tag format. Expected: vX.Y.Z-beta.N"
            exit 1
          fi

          STABLE_VERSION="${BASH_REMATCH[1]}"

          echo "beta_version=$BETA_VERSION" >> $GITHUB_OUTPUT
          echo "stable_version=$STABLE_VERSION" >> $GITHUB_OUTPUT
          echo "Beta: $BETA_VERSION -> Stable: $STABLE_VERSION"

      - name: "Check beta release exists"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BETA_TAG="v${{ steps.parse.outputs.beta_version }}"

          # Verify release exists and is a prerelease
          RELEASE_INFO=$(gh api "repos/${{ github.repository }}/releases/tags/$BETA_TAG" 2>/dev/null || echo "")

          if [ -z "$RELEASE_INFO" ]; then
            echo "::error::Release $BETA_TAG not found"
            exit 1
          fi

          IS_PRERELEASE=$(echo "$RELEASE_INFO" | jq -r '.prerelease')

          if [ "$IS_PRERELEASE" != "true" ]; then
            echo "::error::Release $BETA_TAG is not a prerelease"
            exit 1
          fi

          echo "Beta release validated: $BETA_TAG"

      - name: "Check stable version doesn't exist"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STABLE_TAG="v${{ steps.parse.outputs.stable_version }}"

          if gh api "repos/${{ github.repository }}/releases/tags/$STABLE_TAG" &>/dev/null; then
            echo "::error::Stable release $STABLE_TAG already exists"
            exit 1
          fi

          echo "Stable version $STABLE_TAG is available"

  # =============================================================================
  # Update version and create tag
  # =============================================================================
  prepare-version:
    name: "Prepare Version"
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "Setup Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: "Update version in develop"
        env:
          STABLE_VERSION: ${{ needs.validate.outputs.stable_version }}
        run: |
          git pull origin develop

          # Update all package.json files
          npm version $STABLE_VERSION --no-git-tag-version
          for pkg in packages/app packages/backend packages/landing; do
            if [ -f "$pkg/package.json" ]; then
              cd "$pkg"
              npm version $STABLE_VERSION --no-git-tag-version
              cd - > /dev/null
            fi
          done

          git add package.json package-lock.json \
            packages/app/package.json \
            packages/backend/package.json \
            packages/landing/package.json
          git commit -m "chore(release): v$STABLE_VERSION"
          git push origin develop

      - name: "Create tag on develop"
        env:
          STABLE_VERSION: ${{ needs.validate.outputs.stable_version }}
        run: |
          git tag -a "v$STABLE_VERSION" -m "Release v$STABLE_VERSION"
          git push origin "v$STABLE_VERSION"

  # =============================================================================
  # Build all platforms (fresh build with stable version)
  # =============================================================================
  build:
    name: "Build"
    needs: [validate, prepare-version]
    uses: ./.github/workflows/build-artifacts.yml
    with:
      ref: v${{ needs.validate.outputs.stable_version }}
      artifact-suffix: "-stable"
      sign-macos: true
      sign-windows: true
    secrets: inherit

  # =============================================================================
  # Create stable release
  # =============================================================================
  create-release:
    name: "Create Release"
    needs: [validate, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "Download macOS artifacts"
        uses: actions/download-artifact@v4
        with:
          name: app-macos-stable
          path: assets/macos

      - name: "Download Windows artifacts"
        uses: actions/download-artifact@v4
        with:
          name: app-windows-stable
          path: assets/windows

      - name: "Download Linux artifacts"
        uses: actions/download-artifact@v4
        with:
          name: app-linux-stable
          path: assets/linux

      - name: "Flatten assets"
        run: |
          mkdir -p release-assets
          find assets -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.deb" -o -name "*.rpm" -o -name "*.zip" \) -exec cp {} release-assets/ \;
          echo "Release assets:"
          ls -la release-assets/

      - name: "Generate changelog"
        id: changelog
        env:
          BETA_TAG: v${{ needs.validate.outputs.beta_version }}
        run: |
          # Get the previous stable tag (excluding current)
          CURRENT_TAG="v${{ needs.validate.outputs.stable_version }}"
          PREV_STABLE=$(git tag -l "v*" --sort=-version:refname | grep -v "beta" | grep -v "$CURRENT_TAG" | head -1 || true)

          if [ -n "$PREV_STABLE" ]; then
            COMMITS=$(git log ${PREV_STABLE}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep -v "^- chore(release)" | head -30 || true)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20 | grep -v "^- chore(release)" || true)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -E "^- feat" || true)
          FIXES=$(echo "$COMMITS" | grep -E "^- fix" || true)
          OTHER=$(echo "$COMMITS" | grep -vE "^- (feat|fix)" | head -10 || true)

          {
            echo "changelog<<EOF"
            if [ -n "$FEATURES" ]; then
              echo "### New Features"
              echo "$FEATURES"
              echo ""
            fi
            if [ -n "$FIXES" ]; then
              echo "### Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            if [ -n "$OTHER" ]; then
              echo "### Other Changes"
              echo "$OTHER"
              echo ""
            fi
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: "Delete previous releases"
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          CURRENT_VERSION: v${{ needs.validate.outputs.stable_version }}
        run: |
          echo "Cleaning up previous releases..."

          # Get all stable releases (non-prerelease)
          STABLE_RELEASES=$(gh release list --json tagName,isPrerelease --jq '.[] | select(.isPrerelease == false) | .tagName' || true)

          # Get all beta releases (prerelease)
          BETA_RELEASES=$(gh release list --json tagName,isPrerelease --jq '.[] | select(.isPrerelease == true) | .tagName' || true)

          # Delete previous stable releases
          if [ -n "$STABLE_RELEASES" ]; then
            echo "Found stable releases: $STABLE_RELEASES"
            for TAG in $STABLE_RELEASES; do
              if [ "$TAG" != "$CURRENT_VERSION" ]; then
                echo "Deleting stable release: $TAG"
                gh release delete "$TAG" --yes --cleanup-tag || echo "Failed to delete $TAG"
              fi
            done
          fi

          # Delete all beta releases (they're no longer needed after stable promotion)
          if [ -n "$BETA_RELEASES" ]; then
            echo "Found beta releases: $BETA_RELEASES"
            for TAG in $BETA_RELEASES; do
              echo "Deleting beta release: $TAG"
              gh release delete "$TAG" --yes --cleanup-tag || echo "Failed to delete $TAG"
            done
          fi

          echo "Cleanup complete"

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate.outputs.stable_version }}
          name: "v${{ needs.validate.outputs.stable_version }}"
          body: |
            ## Release v${{ needs.validate.outputs.stable_version }}

            ${{ steps.changelog.outputs.changelog }}

            ---

            ### Downloads

            | Platform | File |
            |----------|------|
            | macOS | `PR-Manager-${{ needs.validate.outputs.stable_version }}.dmg` |
            | Windows | `PRManager-${{ needs.validate.outputs.stable_version }}-Setup.exe` |
            | Linux | `pr-manager_${{ needs.validate.outputs.stable_version }}_amd64.deb` / `.rpm` |
          draft: false
          prerelease: false
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  # =============================================================================
  # Sync main branch
  # =============================================================================
  sync-main:
    name: "Sync Main"
    needs: [validate, create-release]
    if: inputs.sync_main
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "Setup Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: "Try fast-forward merge"
        id: merge
        continue-on-error: true
        run: |
          git fetch origin main develop
          git checkout main
          git merge origin/develop --ff-only
          git push origin main
          echo "merged=true" >> $GITHUB_OUTPUT
          echo "Main branch updated successfully via fast-forward"

      - name: "Create PR if merge failed"
        if: steps.merge.outputs.merged != 'true'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          STABLE_VERSION: ${{ needs.validate.outputs.stable_version }}
        run: |
          echo "::warning::Fast-forward merge failed, creating PR"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base main --head develop --state open --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists"
            echo "::warning::Please merge PR #$EXISTING_PR to sync main with develop"
          else
            PR_URL=$(gh pr create \
              --base main \
              --head develop \
              --title "chore: sync main with v$STABLE_VERSION" \
              --body "Auto-generated PR to sync main branch with develop after stable release v$STABLE_VERSION.

            Please resolve any conflicts and merge this PR to keep main in sync.")

            echo "Created PR: $PR_URL"
            echo "::warning::Created PR to sync main. Please resolve conflicts and merge."
          fi

  # =============================================================================
  # Deploy
  # =============================================================================
  deploy-backend:
    name: "Deploy Backend"
    needs: create-release
    uses: ./.github/workflows/deploy-backend.yml
    secrets: inherit

  deploy-landing:
    name: "Deploy Landing"
    needs: create-release
    uses: ./.github/workflows/deploy-landing.yml
    secrets: inherit

  # =============================================================================
  # Summary
  # =============================================================================
  summary:
    name: "Summary"
    needs: [validate, build, create-release, sync-main, deploy-backend, deploy-landing]
    if: always() && needs.create-release.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: "Generate summary"
        run: |
          echo "## Stable Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.validate.outputs.stable_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted from:** v${{ needs.validate.outputs.beta_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'Built & Signed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | Created |" >> $GITHUB_STEP_SUMMARY
          echo "| Main sync | ${{ needs.sync-main.result == 'success' && 'Synced' || 'PR created' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result == 'success' && 'Deployed' || 'Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Landing | ${{ needs.deploy-landing.result == 'success' && 'Deployed' || 'Skipped' }} |" >> $GITHUB_STEP_SUMMARY
